---
title: "HR projekt Analiza danych"
date: "`r Sys.Date()`"
output:
  rmdformats::downcute:
    self_contained: true
    default_style: "light"
    downcute_theme: "default"
editor_options: 
  markdown: 
    wrap: 72
---

# **Projekt HR**

Poniższy projekt przedstawia analizę danych opartą na danych
zawierających... Projekt zawiera się w czeterech głównych etapach: 1.
Data cleansing, Wrangling, 2. Wizualizacja danych, 3. Analiza opisowa,
4. Wnioskowanie. Celem projektu jest wykonanie analizy, opartej na
przygotowanym zbiorze danych.

### *Wczytanie bibliotek*

```{r setup, include=FALSE}
## Global options
knitr::opts_chunk$set(cache = TRUE)
options(scipen = 999, digits=6) 
if(!require('DMwR')) install.packages("https://cran.r-project.org/src/contrib/Archive/DMwR/DMwR_0.4.1.tar.gz", repos=NULL, type="source", dependencies=TRUE)
library(naniar)
library(ggplot2)
library(VIM)
library(misty) 
library(dlookr) 
library(rstatix)
library(DataExplorer)
library(editrules)
library(tidyverse)
library(datarium)
library(textclean)
library(mice)
install.packages("readr")
install.packages("dplyr")
install.packages("psych")
install.packages("ggcorrplot")
install.packages("reshape2")
library(readr)
library(dplyr)
library(psych)
library(ggcorrplot)
library(reshape2)
```

# **Etap 1. Data cleansing**

W celu wykonania projektu wczytano zestaw danych.

```{r}
dane <- read.csv(file = "HR.csv")
```

Kolejne wczytanie danych z nagłówkami i specyficznymi separatorami.

```{r}
tabela <- read.csv("HR.csv", header= TRUE, sep=",", dec=",")
```

Następnie wyświetlono dane z tabeli, aby wstępnie zweryfikować ich
poprawność, ilość oraz aby zyskać ogólny pogląd na badane wartości.

```{r}
View(tabela)
```

Ważnym krokiem analizy jest sprawdzenie liczby brakujących wartości w
całym zbiorze danych. Uzyskana wartość to łączna liczba brakujących
obserwacji wśród wszystkich zmiennych.

```{r echo=TRUE}
sum(is.na(tabela))
```

Aby dowiedzieć się szczegółów dotyczących braków zmiennych wykonano
wykres brakujących wartości. Przedstawia on wszystkie zmienne
występujące w zbiorze danych oraz wskazuje te, które zawierają puste
wartości. Jak można odczytać z poniższego wykresu, w zbiorze występują
trzy zmienne, które mają braki. Są to kolejno: Age (100), MonthlyIncome
(150) oraz Attrition(150).

```{r echo=TRUE}
plot_missing(tabela)
```

Kolejną metodą sprawdzającą braki danych jest shadowmapa. Pokazuje ona,
w których kolumnach znajdują się brakujące dane oraz zwraca ich liczbę.

```{r echo=TRUE}
gg_miss_var(tabela) + labs( title = "Shadowmapa brakujących danych", x =
"Kolumny", y = "Liczba brakujących wartości" )
```

Poniżej zastosowano bardziej szczegółowy wykres, który pokazuje nie
tylko w których zmiennych są braki, ale także wskazuje wiersz, w ktorym
one występują.

```{r echo=TRUE}
vis_miss(tabela)
```

Podsumowanie braków danych w formie tabeli.

```{r echo=TRUE}
wybrane_kolumny <- tabela %>% select(Attrition, MonthlyIncome, Age)
miss_var_summary(wybrane_kolumny)
```

Wizualizacja braków danych w formie wykresu słupkowego. Poniżej
wyświetlane są zależności pomiędzy brakami danych. Z wykresu wynika, że
nie ma wzorca braku danych, są one niezależne. Jest niewiele przypadków
(łącznie 34), gdzie brakuje więcej niż jednej zmiennej w wierszu, ale
nie można tego uznać za regułę.

```{r echo=TRUE}
gg_miss_upset(tabela)
```

Kolejnym krokiem w przygotowaniu danych do ich póżniejszej analizy jest
sprawdzenie ich spójności. Dane powinny spełniać określone przez
analityka reguły, aby nie fałszowały późniejszych obliczeń. W tym
projekcie określono pięć reguł, które musiały zostać spełnione przez
odpowiednie zmienne. Są to kolejno: wiek pracownika większy lub równy od
18 i mniejszy od 100, odejście pracownika z firmy ma mieć wartość prawda
lub fałsz, miesięczny dochód większy od zera oraz lata pracy z firmie
większe lub równe zero.

```{r}
RULE <- editset(c(
  "Age >= 18",
  "Age <100",
  "Attrition %in% c('Yes','No')",
  "MonthlyIncome > 0",
  "YearsAtCompany >= 0"
))
RULE
```

Następnie zbadano ile razy w zbiorze danych łamane są ustanowione
wcześniej reguły. Tutaj nie do końca umiem zinterpretować
#naprawić błędy (zamienic na NA) i potem wypełnić braki imputacją
```{r}
violations <- violatedEdits(RULE, tabela)
summary(violations)
summary(violatedEdits(RULE, tabela))
plot(violations)
```
```{r}
for (i in 1:nrow(violations)) {
  for (j in 1:ncol(violations)) {
    if (!is.na(violations[i, j]) && violations[i, j]) {
      dane[i, colnames(violations)[j]] <- NA
    }
  }
}
```

Wypełnianie braków danych\*\* W tym etapie projektu wypełniliśmy braki
danych.

Wypełnienie braków danych - wszystkich wartosci


# powyzsza metoda wypelnila wszystkie brakujace dane i sprwadza czy dane zostały uzupełnione

```{r}
tabela_knn <- kNN(tabela, k = 5)
sum(is.na(tabela_knn))
```

Poniższy wykres przedstawia wartości odstające w badanej populacji.
Dlaczego tutaj jest ten wykres?

```{r}
boxplot(tabela$Age)
boxplot(tabela$MonthlyIncome)
```

# **Etap 2. Data wrangling**

Manipulacja danymi

```{r}

tabela_knn %>%
  filter(Age < 22, MonthlyIncome < 1500, YearsWithCurrManager < 5) %>%
select(Age, BusinessTravel, Department, Education, Gender, MonthlyIncome, YearsWithCurrManager)
  
```

Poniżej dokonano sortowania danych za pomocą jednej lub więcej
zmiennych. Dodatkowo użyto funkcji 'count', aby zliczyć posortowane
obserwacje. Z tego wiadomo na przykład, że w firmie pracowało więcej
mężczyzn niż kobiet lub że najwięcej pracowników pochodziło z działu
badań i rozwoju.
#zamiast tego wykresiki ile % pracuje mezczyzni kobiety, ile zrezygnowalo itd., w jakim wieku rezygnuja itd
```{r}
tabela_knn %>%
  count(Department)
tabela_knn %>%
  count(Gender)
tabela_knn %>%
  count(JobRole)
        
```

Zagłębiając się w funkcję sortowania, wykonano podsumowanie libczy osób
na danych stanowiskach wraz z podaniem średniego zarobku na tym
stanowisku. Uzyskane informacje posortowano malejąco. Z poniższej
analizy wynika, że najwięcej osób pracowało na stanowisku dyrektora ds.
sprzedaży, natomiast najmniej w dziale zasobów ludzkich. Średnio
najlepiej nagradzanym stanowiskiem był przedstawiciel handlowy,
natomiast najlepiej nagradzanym był manager.

```{r}
tabela_knn %>%
  group_by(JobRole) %>%
  summarise(
    Liczba_osób = n(),
    Średni_zarobek = mean(MonthlyIncome)
  ) %>%
  arrange(desc(Liczba_osób))
```

# **Etap 3. Data visualization**

### **Wykres 1 - Satysfakcja z pracy**

Poniższy wykres przedstawia jak pracownicy z podziałem na płeć oceniali
swoją staysfkację z pracy w czteropunktowej skali. Zdecydowanie więcej
mężczyzn wskazało dwa najwyższe poziomy zadowolenia w porównaniu do
kobiet.

```{r}
ggplot(tabela_knn, aes(x=JobSatisfaction)) +
  geom_histogram(bins=10) +
  labs(title="Satysfakcja z pracy", x="Ocena od 1 do 4", y="Liczba osób") +
  theme_bw() +
  facet_grid(~Gender)
```

### **Wykres 2 - Zależność wyształcenia względem zarobków**

Poniższy wykres przedstawia zależność poziomu wykształcenia do zarobków.
Wydawać by się mogło, że wykształcenie znacznie wpływa na zarobki - co
do zasady czym wyższe wykształcenie tym wyższe zarobki. Jednak w badanej
populacji nie jest to zasadą. Choć rzeczywiście tendencja zaborków jest
rosnąca oraz minimalne zarobki zwiększają się wraz z kolejnym poziomem
wykształcenia, to najwyższe wartości obserwowane są w każdym z poziomów.
Nie są to wcale pojedncze wartości odstające lecz powtarzające się
obserwacje. Natomiast czym wyższe jest wykształcenie tym więcej
pracowników zarabia statystycznie więcej niż z niższym wykształceniem.
Widać również, że płeć nie ma specjalnego wpływu na zarobki. Zarówno
kobiety i mężczyźni w badanej populacji byli w stanie zarobić zarówno
mało, średnio jak i uzyskać te najwyższe wartości.

### **Wykres 3 - Zależność wieku względem zarobków** 

Ten punktowy wykres przedstawia zależność wieku pracownika względem jego
zarobków. W tym przypadku logiczne założenie, że wraz z wiekiem zarobki
powinny rosnąć jak najbardziej się sprawdza. Jak widać linia trendu jest
rosnącą funckją liniową, wskazującą na średni wzrost zarobków względem
wieku. Naturalnie występują wartości skrajnie odstające, gdzie 60 -
latek zarabia mniej niż 20 - latek czy 30 - latek. Dodatkowo wykres
podzielono względem płci. Linie trednu praktycznie się na siebie
nakładają, co wskazuje na to, że płeć nie ma zbytniego wpływu na zarobki
względem wieku - liczy się doświadczenie.

```{r}
ggplot(tabela_knn, aes(x=Age, y=MonthlyIncome, color=Gender)) +
  geom_point() +
  geom_smooth(method="lm") + 
  theme_light() +
  theme(legend.position = c(0.1, 0.85)) + 
  labs(
    title = "Zależność wieku względem zarobków",
    x = "Wiek",
    y = "Miesięczne zarobki") 
```
### **Wykres 7 - Zależność satysfakcji z pracy względem odejść praconików**

Na poniższym wykresie przedstawiono jak satysfakcja z pracy wpływa na decyzję pracownika o odejściu. Zdecydowanie widać, iż więcej jest pracowników, którzy zostają w firmie niż tych, którzy z niej odchodzą. Badana populacja wykazuje się bardzo wysoką satysfakcją z pracy - tych, którzy zostali i ocenili swoje zadowolonie najwyższym punktem jest niemalże dwuktornie więcej niż tych najmniej zadowolonych. 
Natomiast odejście z pracy nie do końca podyktowane jest małą satysfakcją z pracy. Najwięcej pracowników, którzy odeszli z firmy ocenili swoje zadolowanie na 3 w czterostopniowej skali. Zatem wysoka satysfakcja nie gwaratnuje zatrzymanie pracownika. 

```{r}
ggplot(data = tabela_knn, aes(x = JobSatisfaction, fill = Attrition)) +
  geom_histogram(binwidth = 1, position = "dodge", color = "black") +
  facet_grid(. ~ Attrition) +
  scale_fill_manual(values = c("skyblue", "orange")) +
  labs(
    title = "Rozkład satysfakcji pracy do odejść pracowników",
    x = "Satysfakcja z pracy",
    y = "Liczba osób",
    fill = "Odejście pracownika"
  ) +
  theme_minimal()
```

### **Wykres 8 - Zależność liczby lat pracy w firmie (YearsAtCompany) względem odejść (attrition) Wykres ten pokaże, jak liczba lat pracy rozkłada się w grupie pracowników, którzy odeszli, w porównaniu do tych, którzy pozostali w firmie **

```{r}
ggplot(data = tabela_knn, aes(x = YearsAtCompany, fill = Attrition)) +
  geom_histogram(binwidth = 1, position = "dodge", color = "black") +
  facet_grid(. ~ Attrition) +
  scale_fill_manual(values = c("darkgreen", "orange")) +
  labs(
    title = "Zależność liczby lat pracy w firmie względem odejść",
    x = "liczby lat pracy w firmie",
    y = "Liczba osób",
    fill = "Odejście pracownika"
  ) +
  theme_minimal()
```
### **Wykres 9 - Zależność liczby stawki godzinowej (HourlyRate) względem odejść (Attrition)**
```{r}
ggplot(tabela_knn, aes(x = Attrition, y = HourlyRate )) +
  geom_boxplot() +
  coord_flip()
  labs(
    title = "Wykres pudełkowy dla zmiennej Attrition",
    x = "Attrition (Yes/No)",
    y = "HourlyRate"
  ) +
  theme_minimal()
```
### **Wykres 10 - Zależność liczby lat od ostatniego awansu (YearsSinceLastPromotion) względem odejść (attrition)**
?
?
?
```{r}
ggplot(data = tabela_knn, aes(x = YearsSinceLastPromotion, fill = Attrition)) +
  geom_histogram(binwidth = 1, position = "dodge", color = "white") +
  facet_grid(. ~ Attrition) +
  scale_fill_manual(values = c("skyblue", "violet")) +
  labs(
    title = "Zależność liczby lat od ostatniego awansu względem odejść",
    x = "lata od ostatniego awansu",
    y = "Liczba osób",
    fill = "Odejście pracownika"
  ) +
  theme_minimal()
```
# Wykres 11 - Korelacja rotacji pomiedzy dzialami(Department) a odejscia z pracy (Atrittion)
?
?
?
``` {r}
data_percent <- tabela_knn %>%
  group_by(Department, Attrition) %>%
  summarise(count = n()) %>%
  group_by(Department) %>%
  mutate(percent = count / sum(count) * 100)

ggplot(data_percent, aes(x=Department, y=count, fill=Attrition)) +
  geom_bar(stat="identity", position="dodge") +
  geom_text(aes(label=sprintf("%.1f%%", percent)), position=position_dodge(width=0.9), vjust=-0.25) +
  theme_light() +
  labs(
    title = "Zależność rotacji pracownikow pomiedzy dzialami a odejscia z pracy",
    x = "Dział",
    y = "Liczba osób",
    fill = "Odejście pracownika"
  ) +
  theme(legend.position = c(0.85, 0.85))
```
# Heatmapa - wersja 2 Heatmapa korelacji zmiennych z odejściami pracowników
```{r}
# Tworzenie zmiennej binarnej dla Attrition
tabela_knn$Attrition_bin <- ifelse(tabela_knn$Attrition == "Yes", 1, 0)

# Wybrane zmienne do analizy
selected_vars <- tabela_knn[, c("Age", "MonthlyIncome", "JobSatisfaction", "YearsAtCompany", "Attrition_bin")]

# Obliczenie macierzy korelacji
cor_matrix <- cor(selected_vars, use = "complete.obs")

# Zamiana macierzy korelacji na procenty
cor_matrix_percent <- cor_matrix * 100

# Przekształcenie macierzy do formatu długiego
melted_cor_matrix <- melt(cor_matrix_percent)

# Tworzenie heatmapy z wartościami procentowymi
ggplot(data = melted_cor_matrix, aes(x = Var1, y = Var2, fill = value)) + 
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "darkblue", high = "darkred", mid = "white", midpoint = 0, limit = c(-100, 100), space = "Lab", name="Korelacja (%)") +
  geom_text(aes(label = sprintf("%.1f%%", value)), color = "black", size = 4) +  # Dodanie etykiet procentowych
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  coord_fixed()
```
# Rozklad - odejscia wgledem plci (Gender), wieku (Age), i stanu cywilnego (MaritialStatus)
# sprawdzić czy coś się nie powtarza
```{r}
# Tworzenie zmiennej binarnej dla Attrition (1 = Yes, 0 = No)
tabela_knn$Attrition_bin <- ifelse(tabela_knn$Attrition == "Yes", 1, 0)

# 1. Rozkład odejść w zależności od płci (Gender)
ggplot(tabela_knn, aes(x = Gender, fill = Attrition)) +
  geom_bar(position = "fill") +
  labs(title = "Rozkład odejść w zależności od płci", y = "Proporcja", x = "Płeć") +
  scale_fill_manual(values = c("No" = "lightblue", "Yes" = "darkred"), name = "Attrition") +
  theme_minimal()

# 3. Rozkład odejść w zależności od stanu cywilnego (MaritalStatus)
ggplot(tabela_knn, aes(x = MaritalStatus, fill = Attrition)) +
  geom_bar(position = "fill") +
  labs(title = "Rozkład odejść w zależności od stanu cywilnego", y = "Proporcja", x = "Stan cywilny") +
  scale_fill_manual(values = c("No" = "lightblue", "Yes" = "darkred"), name = "Attrition") +
  theme_minimal()

# 5. Wpływ wynagrodzenia (MonthlyIncome) na odejścia
ggplot(tabela_knn, aes(x = MonthlyIncome, fill = Attrition)) +
  geom_density(alpha = 0.5) +
  labs(title = "Wpływ wynagrodzenia na odejścia", x = "Miesięczne wynagrodzenie", y = "Gęstość") +
  scale_fill_manual(values = c("No" = "lightblue", "Yes" = "darkred"), name = "Attrition") +
  theme_minimal()

# 7. Odejścia w zależności od liczby godzin pracy (OverTime)
ggplot(tabela_knn, aes(x = OverTime, fill = Attrition)) +
  geom_bar(position = "fill") +
  labs(title = "Odejścia a nadgodziny", y = "Proporcja", x = "Nadgodziny") +
  scale_fill_manual(values = c("No" = "lightblue", "Yes" = "darkred"), name = "Attrition") +
  theme_minimal()

```
# ---------------Analiza Opisowa z pliku od Piotrka----------

# Podstawowe statystyki opisowe dla zmiennych liczbowych
summary(tabela_knn %>% select_if(is.numeric))
describe(tabela_knn %>% select_if(is.numeric))

# Liczność kategorii w zmiennych kategorycznych
categorical_summary <- tabela_knn %>%
  select_if(is.character) %>%
  summarise_all(~list(table(.)))

print(categorical_summary)

# Liczba unikalnych wartości w zmiennych kategorycznych
tabela_knn %>% select_if(is.character) %>% summarise_all(~ n_distinct(.))

# Korelacje między zmiennymi liczbowymi
cor_matrix <- cor(tabela_knn %>% select_if(is.numeric))
ggcorrplot(cor_matrix, type = "lower", lab = TRUE)

# Porównanie średnich miesięcznych zarobków względem nadgodzin
tabela_knn %>%
  group_by(OverTime) %>%
  summarise(Mean_MonthlyIncome = mean(MonthlyIncome))

t.test(MonthlyIncome ~ OverTime, data = tabela_knn)

# Wizualizacja rozkładu wieku pracowników
ggplot(tabela_knn, aes(x = Age)) +
  geom_histogram(binwidth = 5, fill = "blue", color = "black") +
  labs(title = "Rozkład wieku pracowników", x = "Wiek", y = "Liczba pracowników")
  
# --- analiza opisowa z Chata
Interpretacja wyników
#--------------Opisowa--------

# Średnia i mediana: Średnia wieku pracowników wynosi X lat, podczas gdy mediana to Y lat. To sugeruje, że rozkład wieku jest [symetryczny/lekko prawoskośny/lekko lewoskośny].
# Odchylenie standardowe: Odchylenie standardowe dla wieku wynosi Z, co wskazuje na [duże/małe] zróżnicowanie wieku wśród pracowników.
# Kwartyle: 25% pracowników ma wiek poniżej A lat, 50% poniżej B lat, a 75% poniżej C lat.
# Liczność kategorii: W firmie pracuje więcej mężczyzn niż kobiet (X mężczyzn vs Y kobiet).
# Korelacje: Istnieje silna dodatnia korelacja między wiekiem a zarobkami (r = 0.7), co sugeruje, że starsi pracownicy zarabiają więcej.

